<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[黃金俠]]></title>
  <link href="http://rubyist.marsz.tw/atom.xml" rel="self"/>
  <link href="http://rubyist.marsz.tw/"/>
  <updated>2012-05-14T13:40:45+08:00</updated>
  <id>http://rubyist.marsz.tw/</id>
  <author>
    <name><![CDATA[MarsZ]]></name>
    <email><![CDATA[marsz330@gmail.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[讀書心得: 刻意練習(1)]]></title>
    <link href="http://rubyist.marsz.tw/blog/2012-05-14/reading-deliberate-practice-1/"/>
    <updated>2012-05-14T12:28:00+08:00</updated>
    <id>http://rubyist.marsz.tw/blog/2012-05-14/reading-deliberate-practice-1</id>
    <content type="html"><![CDATA[<p>博客來: <a href="http://www.books.com.tw/exep/prod/booksfile.php?item=0010456601" target="_blank">http://www.books.com.tw/exep/prod/booksfile.php?item=0010456601</a><br/>
原書名為 <code>我比別人更認真</code>, 標題下 <code>刻意練習</code> 是因為這是本書的主軸<br/>
我大約在 2010 年中買來看完, 覺得和 <a href="http://www.books.com.tw/exep/prod/booksfile.php?item=0010482162" target="_blank"><code>Rework</code></a> 一樣都是值得一讀再讀的好書 :)</p>

<!-- more -->


<h3>前言</h3>

<p>一~三章舉證不少卓越人士和一般人之間的差異，天賦的因素幾乎是微乎其微，影響最深遠的差異在於 <code>你花了多少時間努力</code></p>

<p>第四章則是本書重點的開始，以一位著名的足球運動員為例，說明努力是如何扭轉態勢&#8230;</p>

<h5>努力通常不是卓越的保證</h5>

<p>因此本書大量研究了各種卓越人士的案例，嘗試從其中找出 &#8220;努力的方法&#8221;，因為不努力是絕對無法邁向頂尖的!!</p>

<h5>自發練習</h5>

<p>大量的統計報告指出，卓越人士和一般人接受訓練的時間是差不多的，智商.環境.生活也都沒有顯著差異。而要提昇表現水準，<code>自發練習</code> 占了最重要的因素。以書中為例，卓越的小提琴家平均獨自練習的時間遠遠多於一般的小提琴家。</p>

<h5>自發練習多半集中在上午</h5>

<p>為了成為頂尖，必須安排固定的時間才能做大量練習，因此多半會選擇在&#8221;精神狀況較佳&#8221;的狀態下進行自發練習。而我個人對此的解讀是 <code>剛睡醒的2 ~ 3小時內</code>，這段時間身心都處在最佳狀態，沒有任何時間比這時候做自發練習更好了。這也可以解釋為什麼成功人士都在早上六起點起床(甚至更早)，利用早晨這 1~2 小時完成當天最重要的工作，然後才準備去上班。</p>

<h5>睡得比較多</h5>

<p>因為投入於自發練習的時間較長較集中，因此卓越人士也比平常人更耗費心力，所以為了保持在最佳狀態下做練習，自然睡得就比較多啦</p>

<h5>十年法則</h5>

<p>頂尖表現者的研究發現一個基調: 不管這些人是誰，也不管他們表現如此精進的原因為何，<code>他們都是經過多年</code>才變得如此出眾，無一例外。也因此說明了許多科學家或作家偉大的成果或作品都是在二十年以上的潛心努力後才問世。這和不久前看到的 <a href="http://www.books.com.tw/exep/prod/booksfile.php?item=0010516443" target="_blank"><code>一萬小時法則</code></a> 呼應。</p>

<h5>刻意練習</h5>

<p>矛盾的是，花在自發練習的時間長並不代表一定能有卓越表現，而這問題在於 <code>對練習定義的模糊</code>，所謂的練習並非是我們所想的&#8221;熟能生巧&#8221;這麼簡單，而是一套更為具體更有架構的 <code>刻意練習</code>，這也是本書從第五章開始所帶出的重點.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[用 backup gem 做自動化備份]]></title>
    <link href="http://rubyist.marsz.tw/blog/2012-03-08/backup-gem/"/>
    <updated>2012-03-08T11:57:00+08:00</updated>
    <id>http://rubyist.marsz.tw/blog/2012-03-08/backup-gem</id>
    <content type="html"><![CDATA[<p>source: <a href="https://github.com/meskyanichi/backup" target="_blank">https://github.com/meskyanichi/backup</a><br/>
和 <a href="http://godrb.com/" target="_blank">God</a> 一樣是一個獨立的 gem，因此也可用於其他語言</p>

<!-- more -->


<p><code>backup</code> 的特色:</p>

<ol>
<li>可備份 <code>Redis</code>、<code>MongoDB</code>、<code>Mysql</code> 等 DB</li>
<li>可備份檔案、目錄</li>
<li>備份可儲存於 local disk、<code>Amazon S3</code>、<code>Dropbox</code> 或透過 <code>ftp</code>.<code>scp</code> 等協定將檔案上傳</li>
</ol>


<p>範例檔的備份標的:</p>

<ol>
<li><code>Mysql</code></li>
<li>使用者上傳之頭像圖檔儲存於 <code>Rails</code> public/uploads</li>
<li>備份檔案上傳至 <code>Amazon S3</code></li>
</ol>


<h4>安裝</h4>

<p><code>gem install backup</code></p>

<h4>範例</h4>

<p>打開空檔案即可使用</p>

<figure class='code'><figcaption><span>backup_config.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Backup</span><span class="o">::</span><span class="no">Model</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:my_app</span><span class="p">,</span> <span class="s1">&#39;db data of my app&#39;</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="c1"># mysql 備份</span>
</span><span class='line'>  <span class="n">database</span> <span class="no">MySQL</span> <span class="k">do</span> <span class="o">|</span><span class="n">db</span><span class="o">|</span>
</span><span class='line'>    <span class="n">db</span><span class="o">.</span><span class="n">name</span>               <span class="o">=</span> <span class="s2">&quot;my_app_db&quot;</span>
</span><span class='line'>    <span class="n">db</span><span class="o">.</span><span class="n">username</span>           <span class="o">=</span> <span class="s2">&quot;root&quot;</span>
</span><span class='line'>    <span class="n">db</span><span class="o">.</span><span class="n">password</span>           <span class="o">=</span> <span class="s2">&quot;12341234&quot;</span>
</span><span class='line'>    <span class="n">db</span><span class="o">.</span><span class="n">host</span>               <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>
</span><span class='line'>    <span class="n">db</span><span class="o">.</span><span class="n">port</span>               <span class="o">=</span> <span class="mi">3306</span>
</span><span class='line'>    <span class="n">db</span><span class="o">.</span><span class="n">socket</span>             <span class="o">=</span> <span class="s2">&quot;/tmp/mysql.sock&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># user 頭像檔案  </span>
</span><span class='line'>  <span class="n">archive</span> <span class="ss">:uploads</span> <span class="k">do</span> <span class="o">|</span><span class="n">archive</span><span class="o">|</span>
</span><span class='line'>    <span class="n">archive</span><span class="o">.</span><span class="n">add</span> <span class="s2">&quot;/path/to/my_app/public/uploads&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># 上傳至 S3  </span>
</span><span class='line'>  <span class="n">store_with</span> <span class="no">S3</span> <span class="k">do</span> <span class="o">|</span><span class="n">s3</span><span class="o">|</span>
</span><span class='line'>    <span class="n">s3</span><span class="o">.</span><span class="n">access_key_id</span>      <span class="o">=</span> <span class="s2">&quot;12341234&quot;</span>
</span><span class='line'>    <span class="n">s3</span><span class="o">.</span><span class="n">secret_access_key</span>  <span class="o">=</span> <span class="s2">&quot;!@#$%^&amp;*(&quot;</span>
</span><span class='line'>    <span class="n">s3</span><span class="o">.</span><span class="n">region</span>             <span class="o">=</span> <span class="s2">&quot;us-east-1&quot;</span>
</span><span class='line'>    <span class="n">s3</span><span class="o">.</span><span class="n">bucket</span>             <span class="o">=</span> <span class="s2">&quot;my_app_backup&quot;</span>
</span><span class='line'>    <span class="n">s3</span><span class="o">.</span><span class="n">path</span>               <span class="o">=</span> <span class="s1">&#39;/&#39;</span>
</span><span class='line'>    <span class="n">s3</span><span class="o">.</span><span class="n">keep</span>               <span class="o">=</span> <span class="mi">50</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># 壓縮打包設定</span>
</span><span class='line'>  <span class="n">compress_with</span> <span class="no">Gzip</span> <span class="k">do</span> <span class="o">|</span><span class="n">compression</span><span class="o">|</span>
</span><span class='line'>    <span class="n">compression</span><span class="o">.</span><span class="n">best</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>    <span class="n">compression</span><span class="o">.</span><span class="n">fast</span> <span class="o">=</span> <span class="kp">false</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>執行</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">backup</span> <span class="n">perform</span> <span class="o">-</span><span class="n">t</span> <span class="n">my_app</span> <span class="o">-</span><span class="n">c</span> <span class="n">backup_config</span><span class="o">.</span><span class="n">rb</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>就可進行備份</p>

<p>若要做 <code>Rails</code> 定期備份, 再將指令整合於 <code>whenever</code> 即可<br/>
另外再提供儲存於 local disk 的範例</p>

<figure class='code'><figcaption><span>backup_config.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">store_with</span> <span class="no">Local</span> <span class="k">do</span> <span class="o">|</span><span class="n">local</span><span class="o">|</span>
</span><span class='line'>    <span class="n">local</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;/path/to/back/dir&quot;</span>
</span><span class='line'>    <span class="n">local</span><span class="o">.</span><span class="n">keep</span> <span class="o">=</span> <span class="mi">50</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Rspec 設定 request 或 controller 的 spec 中 render view]]></title>
    <link href="http://rubyist.marsz.tw/blog/2012-03-06/rspec-render-views/"/>
    <updated>2012-03-06T11:05:00+08:00</updated>
    <id>http://rubyist.marsz.tw/blog/2012-03-06/rspec-render-views</id>
    <content type="html"><![CDATA[<p><code>rspec rails</code> 中預設是不會 render view 的, 因此 <code>response.body</code> 的內容會是空字串</p>

<!-- more -->


<p>為了讓 response.body 能實際的把 view render 出來, 可以有個別或預設的作法</p>

<p>個別</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">describe</span> <span class="no">UsersController</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">render_views</span>
</span><span class='line'>  <span class="n">it</span> <span class="s2">&quot;GET #index&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">get</span> <span class="ss">:index</span>
</span><span class='line'>    <span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">should</span> <span class="n">match</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>預設</p>

<figure class='code'><figcaption><span>spec/spec_helper.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">RSpec</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">render_views</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>小弟個人較偏好每個 request / controller 的 spec 都要 render_view<br/>
一方面可以檢驗 view 的正確性<br/>
若 view 中有使用 helper method, 也可以順便檢驗</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Rspec 檔案上傳的測試]]></title>
    <link href="http://rubyist.marsz.tw/blog/2012-03-04/rspec-file-upload/"/>
    <updated>2012-03-04T10:45:00+08:00</updated>
    <id>http://rubyist.marsz.tw/blog/2012-03-04/rspec-file-upload</id>
    <content type="html"><![CDATA[<p><code>controller</code> 的測試中, 總是免不了要處理檔案上傳, rails 中的測試環境當然也提供了這樣的機制</p>

<!-- more -->


<h4>範例</h4>

<p>假設要模擬 view 中 <code>&lt;input type="file" name="user[avatar]" /&gt;</code> 的檔案上傳</p>

<figure class='code'><figcaption><span>spec/requests/users_controller_spec.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">querys</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:avatar</span> <span class="o">=&gt;</span> <span class="n">fixture_file_upload</span><span class="p">(</span><span class="s2">&quot;/example.jpg&quot;</span><span class="p">,</span><span class="s2">&quot;image/jpeg&quot;</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'><span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="n">querys</span>
</span><span class='line'><span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">be_success</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>/example.jpg</code> 會抓 <code>spec/fixtures/example.jpg</code> 做為上傳用的範例圖檔<br/>
<code>image/jpeg</code> 則是 <code>MIME type</code></p>

<p>亦可寫在 <code>factory</code> 中</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Factory</span> <span class="ss">:video_file</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">file</span> <span class="p">{</span> <span class="n">fixture_file_upload</span> <span class="s1">&#39;/test.png&#39;</span><span class="p">,</span> <span class="s1">&#39;image/png&#39;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">after_create</span> <span class="k">do</span> <span class="o">|</span><span class="n">video</span><span class="p">,</span> <span class="n">proxy</span><span class="o">|</span>
</span><span class='line'>    <span class="n">proxy</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">close</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>相關可參考<a href="http://apidock.com/rails/ActionDispatch/TestProcess/fixture_file_upload" target="_blank">Api Dock</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Url helper 中自定 host]]></title>
    <link href="http://rubyist.marsz.tw/blog/2012-03-02/url-helper-set-host/"/>
    <updated>2012-03-02T10:39:00+08:00</updated>
    <id>http://rubyist.marsz.tw/blog/2012-03-02/url-helper-set-host</id>
    <content type="html"><![CDATA[<p>想要吐出 full url 時, 會用 <code>xxx_url</code>, rails 會抓 request 中的 host 做為 url 的 host, 但是當執行環境並非透過 http request (例如 background job), host 得自行指定</p>

<!-- more -->


<p>rails 的 url helper 有提供參數 <code>:host</code> 可自行指定</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">users_url</span> <span class="ss">:host</span> <span class="o">=&gt;</span> <span class="s2">&quot;foo.com&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>若想要設定為預設, 可在 controller 中 override <code>default_url_options</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">default_url_options</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span><span class="ss">:host</span> <span class="o">=&gt;</span> <span class="s2">&quot;ohmygod.com&quot;</span><span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Factory Girl 的回呼 (callbacks)]]></title>
    <link href="http://rubyist.marsz.tw/blog/2012-02-29/factory-girl-callbacks/"/>
    <updated>2012-02-29T10:18:00+08:00</updated>
    <id>http://rubyist.marsz.tw/blog/2012-02-29/factory-girl-callbacks</id>
    <content type="html"><![CDATA[<p>在寫測試中, 有許多的情境, 可能會需要在產生測試用資料後做許多處理, 因此 <code>Factory Girl</code> 本身也提供了 <code>callback</code> 機制&#8230;</p>

<!-- more -->




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">sequence</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">&quot;foo</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">@bar.com&quot;</span> <span class="p">}</span>
</span><span class='line'>    <span class="nb">name</span> <span class="s2">&quot;barbar&quot;</span>
</span><span class='line'>    <span class="n">password</span> <span class="s2">&quot;12341234&quot;</span>
</span><span class='line'>    <span class="n">after_create</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
</span><span class='line'>      <span class="c1"># callback code block here</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>詳細使用方式可見 <a href="https://github.com/thoughtbot/factory_girl/blob/master/GETTING_STARTED.md" target="_blank">官方說明文件</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[factory_girl 中的 model 關連 (association)]]></title>
    <link href="http://rubyist.marsz.tw/blog/2012-02-27/factory-girl-for-associations/"/>
    <updated>2012-02-27T09:42:00+08:00</updated>
    <id>http://rubyist.marsz.tw/blog/2012-02-27/factory-girl-for-associations</id>
    <content type="html"><![CDATA[<p>不論是 <code>one-to-one</code> <code>one-to-many</code> 或 <code>many-to-many</code>, 我們都希望 model 中的關連也能反應到 <code>factory_girl</code> 的定義中</p>

<!-- more -->


<p>方法如下:  (brand has many products)</p>

<figure class='code'><figcaption><span>spec/factories/brands.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:brand</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">sequence</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">&quot;brand name </span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>spec/factories/products.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:products</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">name</span> <span class="s2">&quot;product name&quot;</span>
</span><span class='line'>    <span class="n">brand</span> <span class="k">do</span>
</span><span class='line'>      <span class="no">Factory</span> <span class="ss">:brand</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>app/models/product.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:brand</span>  <span class="c1"># brand_id</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>如此只要每次 <code>Factory(:product)</code> , 該 product 的 brancd 也會透過 brancd 產生, 而不需要再每次的 factory 中去進行關連了 <code>Factory(:product, :brand =&gt; Factory(:brand))</code></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[factory_girl 的 validates_uniqueness_of 欄位問題]]></title>
    <link href="http://rubyist.marsz.tw/blog/2012-02-25/factory-girl-for-uniqueness-column/"/>
    <updated>2012-02-25T09:25:00+08:00</updated>
    <id>http://rubyist.marsz.tw/blog/2012-02-25/factory-girl-for-uniqueness-column</id>
    <content type="html"><![CDATA[<p><code>model</code> 中有 <code>validates_uniqueness_of</code> 的欄位, 在 <code>factory_girl</code> 中可透過 <code>sequence</code> 來避免兩次以上的 factory 因 validation 沒過而無法產生假資料的情況</p>

<!-- more -->




<figure class='code'><figcaption><span>spec/factories/users.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">sequence</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
</span><span class='line'>      <span class="s2">&quot;foo</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">@bar.com&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="nb">name</span> <span class="s2">&quot;barbar&quot;</span>
</span><span class='line'>    <span class="n">password</span> <span class="s2">&quot;12341234&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>n</code> 為流水號, 因此可用於 <code>number</code> 或 <code>string</code> 類型的 column</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Bigtuna 保持 delayed_job 持續執行]]></title>
    <link href="http://rubyist.marsz.tw/blog/2012-02-23/bigtuna-delayedjob-persistant-by-god/"/>
    <updated>2012-02-23T08:59:00+08:00</updated>
    <id>http://rubyist.marsz.tw/blog/2012-02-23/bigtuna-delayedjob-persistant-by-god</id>
    <content type="html"><![CDATA[<p><code>BigTuna</code> 是透過 <a href="https://github.com/tobi/delayed_job" target="_blank">delayed_job</a> 讓所有 build 中的 process 的能夠正常運作<br/>
當 <code>delayed_job</code> 因為某種不明因素終止時, 就得再 ssh 到 server 重啟 <code>delayed_job</code>&#8230;</p>

<!-- more -->


<p><a href="http://godrb.com/" target="_blank">God</a> 是一套獨立的 <code>rubygems</code> <br/>
可以讓你在 <code>linux</code> 環境下監控某 process, 並且保持其持續且正常運作<br/>
因此我們可透過 <code>God</code> 來使 <code>delayed_job</code> 不被意外終止</p>

<h4>安裝</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo su -
</span><span class='line'>gem install god</span></code></pre></td></tr></table></div></figure>


<h4>BigTuna 的 god-ruby 範例檔</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">God</span><span class="o">.</span><span class="n">watch</span> <span class="k">do</span> <span class="o">|</span><span class="n">w</span><span class="o">|</span>
</span><span class='line'>  <span class="n">w</span><span class="o">.</span><span class="n">uid</span> <span class="o">=</span> <span class="s2">&quot;passenger&quot;</span>  <span class="c1"># bigtuna 在 linux 下的 user id</span>
</span><span class='line'>  <span class="n">w</span><span class="o">.</span><span class="n">gid</span> <span class="o">=</span> <span class="s2">&quot;passenger&quot;</span>  <span class="c1"># bigtuna 在 linux 下的 group id</span>
</span><span class='line'>  <span class="n">w</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;bigtuna-delayed_job&quot;</span>  <span class="c1"># 在 god 中的名稱</span>
</span><span class='line'>  <span class="c1"># 執行 delayed_job 的指令</span>
</span><span class='line'>  <span class="n">w</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="s2">&quot;cd /path/to/bigtuna &amp;&amp; RAILS_ENV=production ./script/delayed_job start&quot;</span>
</span><span class='line'>  <span class="n">w</span><span class="o">.</span><span class="n">keepalive</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h4>以 root 身分執行 god</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">god</span> <span class="o">-</span><span class="n">c</span> <span class="n">delayed_job</span><span class="o">.</span><span class="n">rb</span>
</span></code></pre></td></tr></table></div></figure>


<p>執行後可透過 <code>ps axu|grep "god"</code> 或 <code>ps axu|grep "delayed_job"</code> 看到 <code>god</code> 啟動 <code>delayed_job</code> 的相關 process</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[用 resque 實作背景作業 ( 佈署篇)]]></title>
    <link href="http://rubyist.marsz.tw/blog/2012-02-21/resque-deploy-worker/"/>
    <updated>2012-02-21T01:56:00+08:00</updated>
    <id>http://rubyist.marsz.tw/blog/2012-02-21/resque-deploy-worker</id>
    <content type="html"><![CDATA[<p>透過 capistrano 佈署到 server 時，除了需要啟動 worker 之外，也會希望在每次佈署後，也重新啟動 worker<br/>
因為 worker 是透過 rake 啟動的，所以當 perform 相關的程式有修改時，worker 也必須重新啟動<br/>
以下將介紹如何將重啟 worker 整合到 capistrano 中</p>

<!-- more -->


<h4>將 worker 丟背景執行的方法</h4>

<p>resque 1.9 以上有提供參數 :)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>BACKGROUND=yes QUEUE=foo_queue bundle exec rake environment resque:work</span></code></pre></td></tr></table></div></figure>


<p>背景的 worker 要留一下 pid file, 以方便 kill</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>PIDFILE=./resque.pid BACKGROUND=yes QUEUE=foo_queue bundle exec rake environment resque:work</span></code></pre></td></tr></table></div></figure>


<h4>整合 capistrano</h4>

<p>deploy 中加 restart_resque 的 task</p>

<figure class='code'><figcaption><span>config/deploy.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">namespace</span> <span class="ss">:deploy</span> <span class="k">do</span>
</span><span class='line'>  <span class="c1"># .....</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:restart_resque</span><span class="p">,</span> <span class="ss">:roles</span> <span class="o">=&gt;</span> <span class="ss">:app</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">queues</span> <span class="o">=</span> <span class="o">[</span><span class="ss">:foo_queue</span><span class="p">,</span> <span class="ss">:barbar</span><span class="o">]</span>
</span><span class='line'>    <span class="n">queues</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">queue</span><span class="o">|</span>
</span><span class='line'>      <span class="n">pid_file</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">/tmp/pids/resque-</span><span class="si">#{</span><span class="n">queue</span><span class="si">}</span><span class="s2">.pid&quot;</span>
</span><span class='line'>      <span class="n">run</span> <span class="s2">&quot;test -f </span><span class="si">#{</span><span class="n">pid_file</span><span class="si">}</span><span class="s2"> &amp;&amp; cd </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2"> &amp;&amp; kill -s QUIT `cat </span><span class="si">#{</span><span class="n">pid_file</span><span class="si">}</span><span class="s2">` || rm -f </span><span class="si">#{</span><span class="n">pid_file</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="n">run</span> <span class="s2">&quot;cd </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2"> &amp;&amp; PIDFILE=</span><span class="si">#{</span><span class="n">pid_file</span><span class="si">}</span><span class="s2"> RAILS_ENV=</span><span class="si">#{</span><span class="n">rails_env</span><span class="si">}</span><span class="s2"> BACKGROUND=yes QUEUE=</span><span class="si">#{</span><span class="n">queue</span><span class="si">}</span><span class="s2"> bundle exec rake environment resque:work&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="c1">#...</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>上面的例子是以一條 queue 配一個 worker 的方式執行，若要通通塞一個 worker 就 QUEUE=* 吧 XD</p>

<p>restart app 後就 restart resque worker 吧!!</p>

<figure class='code'><figcaption><span>config/deploy.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">after</span> <span class="s1">&#39;deploy:restart&#39;</span><span class="p">,</span> <span class="s1">&#39;deploy:restart_resque&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h4>有關啟動 worker 的參數</h4>

<p>resque 提供了許多參數，讓你可以依照不同的需求執行worker，底下將介紹</p>

<h6>將 worker 執行的結果輸出</h6>

<p>debug 很好用，但個人還是推薦用 rspec 去 debug 吧 XD</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">VVERBOSE</span><span class="o">=</span><span class="mi">1</span> <span class="no">QUEUE</span><span class="o">=*</span> <span class="n">bundle</span> <span class="nb">exec</span> <span class="n">rake</span> <span class="n">environment</span> <span class="n">resque</span><span class="ss">:work</span>
</span></code></pre></td></tr></table></div></figure>


<h6>指定 queue (一條或多條)</h6>

<p>多條可以逗號隔開</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">QUEUES</span><span class="o">=</span><span class="n">file_serve</span><span class="p">,</span><span class="n">warm_cache</span> <span class="n">bundle</span> <span class="nb">exec</span> <span class="n">rake</span> <span class="n">environment</span> <span class="n">resque</span><span class="ss">:work</span>
</span></code></pre></td></tr></table></div></figure>


<p>* 則是所有的 queue</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">QUEUES</span><span class="o">=*</span> <span class="n">bundle</span> <span class="nb">exec</span> <span class="n">rake</span> <span class="n">environment</span> <span class="n">resque</span><span class="ss">:work</span>
</span></code></pre></td></tr></table></div></figure>


<h6>polling 的頻率</h6>

<p>針對即時性高的需求,以秒計,預設為 5 秒</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">INTERVAL</span><span class="o">=</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span> <span class="no">QUEUE</span><span class="o">=</span><span class="n">foo</span> <span class="n">bundle</span> <span class="nb">exec</span> <span class="n">rake</span> <span class="n">environment</span> <span class="n">resque</span><span class="ss">:work</span>
</span></code></pre></td></tr></table></div></figure>


<h6>多個 worker 同步執行</h6>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">COUNT</span><span class="o">=</span><span class="mi">5</span> <span class="no">QUEUE</span><span class="o">=*</span> <span class="n">bundle</span> <span class="nb">exec</span> <span class="n">rake</span> <span class="n">environment</span> <span class="n">resque</span><span class="ss">:workers</span>
</span></code></pre></td></tr></table></div></figure>


<p>但官方推薦用 gem &#8220;god&#8221; 來執行多個 worker<br/>
相關可參考 <a href="https://github.com/defunkt/resque/blob/master/examples/god/resque.god" target="_blank">官方範例</a><br/>
god 也可以用來解決 worker 掛掉的問題<br/>
有關 god 的整合, 有空再分享 :p</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[用 resque 實作背景作業 ( mailer 篇)]]></title>
    <link href="http://rubyist.marsz.tw/blog/2012-02-19/resque-mailer/"/>
    <updated>2012-02-19T01:36:00+08:00</updated>
    <id>http://rubyist.marsz.tw/blog/2012-02-19/resque-mailer</id>
    <content type="html"><![CDATA[<p>寄信的工作是最必要丟背景的。在 web 前端使用的過程中，若要等待 server 產生 email 內容、和 smtp 連線、然後再把信送出去，這樣的過程肯定讓使用品質大大扣分&#8230;<br/>
因此 gem &#8220;resque_mailer&#8221; 將 resque 的 enqueue 和 perform 實作到 ActionMailer::Base 中</p>

<!-- more -->


<p>即原本的 deliver 應該是要根據 app 的 mailer 設定 (smtp或sendmail等) 把信送出<br/>
bundle resqie_mailer 後, deliver 的結果則變成送到 mq 上 (透過 Resque.enqueue)</p>

<h4>安裝</h4>

<figure class='code'><figcaption><span>Gemfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;resque&#39;</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;resque_mailer&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h4>設定</h4>

<figure class='code'><figcaption><span>config/initializers/resque_mailer.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># queue 的名稱</span>
</span><span class='line'><span class="no">Resque</span><span class="o">::</span><span class="no">Mailer</span><span class="o">.</span><span class="n">default_queue_name</span> <span class="o">=</span> <span class="s2">&quot;foo_mailer&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 有 resque_spec</span>
</span><span class='line'><span class="no">Resque</span><span class="o">::</span><span class="no">Mailer</span><span class="o">.</span><span class="n">excluded_environments</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'><span class="c1"># 無 resque_spec</span>
</span><span class='line'><span class="no">Resque</span><span class="o">::</span><span class="no">Mailer</span><span class="o">.</span><span class="n">excluded_environments</span> <span class="o">=</span> <span class="o">[</span><span class="ss">:test</span><span class="p">,</span> <span class="ss">:cucumber</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<h4>使用</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">MyMailer</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Resque</span><span class="o">::</span><span class="no">Mailer</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
</span><span class='line'>    <span class="c1"># .....</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>寄信 (送到 mq)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">MyMailer</span><span class="o">.</span><span class="n">foo</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">deliver</span>
</span></code></pre></td></tr></table></div></figure>


<p>寄信 (直接寄出不送 mq)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">MyMailer</span><span class="o">.</span><span class="n">foo</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">deliver!</span>
</span></code></pre></td></tr></table></div></figure>


<p>這裡要注意!!!!! 因為 resque 會將參數內容送到 mq 上, 而 redis 無法處理 number, string, array, hash 以外的變數, 所以在定義 mailer action 時, 參數務必限制在上述這些變數類型的範圍內</p>

<h4>worker 的執行</h4>

<p>一般 mailer 的 worker 建議獨立一條 queue 執行, 效率會比較好 :p</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">QUEUE</span><span class="o">=</span><span class="n">foo_mailer</span> <span class="n">bundle</span> <span class="nb">exec</span> <span class="n">rake</span> <span class="n">resque</span><span class="ss">:work</span>
</span></code></pre></td></tr></table></div></figure>


<hr />

<p>resque_mailer 簡單, 但仍是 background job<br/>
因此測試還是要多多寫 XD</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[用 resque 實作背景作業 (測試篇 - Rspec)]]></title>
    <link href="http://rubyist.marsz.tw/blog/2012-02-17/resque-spec/"/>
    <updated>2012-02-17T00:40:00+08:00</updated>
    <id>http://rubyist.marsz.tw/blog/2012-02-17/resque-spec</id>
    <content type="html"><![CDATA[<p>不管用什麼方式實作 background job 後<br/>
令人頭痛的是很難知道 worker 在執行工作時有沒有噴 exception<br/>
因此測試就顯得更為重要, 每次佈署前必須做好完整的測試, 以減少 worker 出錯<br/>
當然也可以搭配 Exceptional 或 Aribrake 之類的雲端服務來進行監控&#8230;</p>

<!-- more -->


<p>resque 的測試有專門的 gem, 用來在測試環境下模擬 message queue 和 worker</p>

<p>resque_spec : <a href="https://github.com/leshill/resque_spec" target="_blank">https://github.com/leshill/resque_spec</a></p>

<h4>安裝</h4>

<figure class='code'><figcaption><span>Gemfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;resque_spec&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>這裡要注意一點, 不要在 development 環境下 bundle resque_spec, 即 Gemfile 中的 resque_spec 只能 group 在 test 下, 否則執行 Resque.enqueue 就不會送到 redis 而是送進 resque_spec 中</p>

<h4>使用</h4>

<p>resque_spec 的作法是讓原本丟工作到 mq 上的 Resque.enqueue 改為丟到 resque_spec 模擬的 mq 中<br/>
因此 Gemfile bundle 後, 就可以直接在 rspec 中使用, 以下將介紹 rspec 中常用的語法</p>

<h6>清空 mq 所有的 job</h6>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">describe</span> <span class="s2">&quot;#foo&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">before</span> <span class="k">do</span>
</span><span class='line'>    <span class="no">ResqueSpec</span><span class="o">.</span><span class="n">reset!</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h6>檢查某個 worker 的 job 數</h6>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="no">FooWorker</span><span class="o">.</span><span class="n">should</span> <span class="n">have_queue_size_of</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h6>檢查某個 worker 的 queue 中應該要有的 job</h6>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="no">FooWorker</span><span class="o">.</span><span class="n">should</span> <span class="n">have_queued</span><span class="p">(</span><span class="n">foo</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;bar&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>foo.id, &#8220;bar&#8221; 都是 enqueue 的參數</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="c1"># some where enqueue</span>
</span><span class='line'>  <span class="no">Resque</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="no">FooWorker</span><span class="p">,</span> <span class="n">foo</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;bar&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h6>立即執行不送 queue</h6>

<p>用 &#8220;with_resque&#8221;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">it</span> <span class="s2">&quot;should works&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">with_resque</span> <span class="k">do</span>
</span><span class='line'>    <span class="vi">@foo</span><span class="o">.</span><span class="n">run</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>假設 run 的內容是</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">run</span>
</span><span class='line'>  <span class="no">Resque</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="no">FooWorker</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>在 with_resque 內, Resque.enqueue(FooWorker, id) 相當於 FooWorker.perform(id)</p>

<h6>執行 queue 裡面所有的 job</h6>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">it</span> <span class="s2">&quot;should  works&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="vi">@foo</span><span class="o">.</span><span class="n">run</span>
</span><span class='line'>  <span class="no">ResqueSpec</span><span class="o">.</span><span class="n">perform_all</span><span class="p">(</span><span class="ss">:queue_foo</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>&#8220;queue_foo&#8221; 是 Worker 中定義的 queue name</p>

<h4>整合 ResqueMailer</h4>

<p>gem &#8220;resque_mailer&#8221; 會將 mailer 中的 deliver 行為內容改為 Resque.enqueue<br/>
但是在 test 環境中, resque_mailer 則會還原 deliver 原本的行為<br/>
所以為了 rspec 中也可以測試 mailer 是否 enqueu, 要在 resque_mailer 中的 config 將原本排除掉的 test 環境加入 resque_mailer 的運作中</p>

<figure class='code'><figcaption><span>config/initializers/resque_mailer.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Resque</span><span class="o">::</span><span class="no">Mailer</span><span class="o">.</span><span class="n">excluded_environments</span> <span class="o">=</span> <span class="o">[]</span>
</span></code></pre></td></tr></table></div></figure>


<hr />

<p>一般我們都會將複雜或吃效能的工作丟到背景執行<br/>
而複雜的工作又常常需要 debug<br/>
因此平常應該要養成寫 spec 的習慣<br/>
才不會讓自己跟這些複雜的功能過不去 :p</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[用 resque 實作背景作業 (基本使用篇)]]></title>
    <link href="http://rubyist.marsz.tw/blog/2012-02-15/resque-basic-usage/"/>
    <updated>2012-02-15T15:36:00+08:00</updated>
    <id>http://rubyist.marsz.tw/blog/2012-02-15/resque-basic-usage</id>
    <content type="html"><![CDATA[<p>上篇提到如何進行 redis, resque, worker 的設定安裝
本篇將介紹基本使用方式</p>

<!-- more -->


<h4>參考連結</h4>

<p>RailsCast - 影片: <a href="http://railscasts.com/episodes/271-resque" target="_blank">Resque</a>
RailsCast - 文字: <a href="http://railscasts.com/episodes/271-resque?view=asciicast" target="_blank">
Resque</a>
官方文件: <a href="https://github.com/defunkt/resque" target="_blank">Github</a></p>

<h4>基本使用</h4>

<p>情境: 文章內容更新後, 要重新計算其價值(p幣~XD)</p>

<p>先寫好 worker 要做的事情, worker 可以是任何 class</p>

<figure class='code'><figcaption><span>app/workers/post_evaluate.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">PostEvaluate</span>
</span><span class='line'>
</span><span class='line'>  <span class="vi">@queue</span> <span class="o">=</span> <span class="ss">:post_evaluate</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">perform</span><span class="p">(</span><span class="n">post_id</span><span class="p">,</span> <span class="n">total_time_seconds</span><span class="p">)</span>
</span><span class='line'>    <span class="n">evaluate</span> <span class="no">Post</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">post_id</span><span class="p">),</span> <span class="n">total_time_seconds</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>worker 必備兩個部分:
1. @queue 指定 queue 的名稱
2. class method: perform 執行 job 內容, 參數可自定</p>

<p>接下來是如何把 job 丟上 queue</p>

<figure class='code'><figcaption><span>app/models/post.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">after_save</span> <span class="ss">:evaluate</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">evaluate</span>
</span><span class='line'>  <span class="no">Resque</span><span class="o">.</span><span class="n">enqueue</span> <span class="no">PostEvaluate</span><span class="p">,</span> <span class="nb">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">total_secs</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Resque.enqueue [worker class], [argument 1], [argument 2], &#8230;..</p>

<p>相當於 worker 執行了 PostEvaluate.perform(self.id, total_secs)</p>

<h4>注意事項</h4>

<p>enqueue 的參數類型儘可能簡單: Fixnum, String, Array, Hash<br/>
不要將整個 model 或 class instance 丟到 mq 上<br/>
redis 無法儲存像 model 這樣複雜的變數類型</p>

<p>下一篇將介紹如何寫測試(Rspec)</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[用 resque 實作背景作業 (前置設定篇)]]></title>
    <link href="http://rubyist.marsz.tw/blog/2012-02-13/resque-redis-and-worker-config/"/>
    <updated>2012-02-13T14:51:00+08:00</updated>
    <id>http://rubyist.marsz.tw/blog/2012-02-13/resque-redis-and-worker-config</id>
    <content type="html"><![CDATA[<p>resque 是一套可以用來實作 background job 的 gem<br/>
舉凡長時間的執行如 email, 點數計算等等非即時性的工作, 都可以採用非同步執行<br/>
以加速前端服務的反應速度<br/>
resque 是以 redis 做為 message queue server 的方式來進行&#8230;</p>

<!-- more -->


<h4>參考連結</h4>

<p>RailsCast - 影片: <a href="http://railscasts.com/episodes/271-resque" target="_blank">Resque</a><br/>
RailsCast - 文字: <a href="http://railscasts.com/episodes/271-resque?view=asciicast" target="_blank">Resque</a><br/>
官方文件: <a href="https://github.com/defunkt/resque" target="_blank">Github</a></p>

<h4>安裝 Gem</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Gemfile
</span><span class='line'>gem "resque"</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bundle install</span></code></pre></td></tr></table></div></figure>


<h4>安裝 redis</h4>

<p>MacOS</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo brew install redis</span></code></pre></td></tr></table></div></figure>


<p>Debian / Ubuntu</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo apt-get install redis-server</span></code></pre></td></tr></table></div></figure>


<h4>啟動/停止 redis server</h4>

<p>MacOS</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># 啟動
</span><span class='line'>/usr/local/bin/redis-server /usr/local/etc/redis.conf
</span><span class='line'># 停止 ps + kill :p
</span><span class='line'>sudo kill -SIGHUP $(ps aux|grep 'redis-server'|grep -v 'grep'|awk '{print $2}')</span></code></pre></td></tr></table></div></figure>


<p>Debian / Ubuntu</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># 啟動
</span><span class='line'>sudo service redis-server start
</span><span class='line'># 停止
</span><span class='line'>sudo service redis-server stop</span></code></pre></td></tr></table></div></figure>


<h4>Resque 中的 redis 設定</h4>

<p>由於 resque 必須將 job 丟上 redis (mq server)<br/>
因此必須設定連線的位址</p>

<p>手動建立兩個檔案<br/>
config/redis.yml => redis 的連線設定檔<br/>
config/initializers/resque.rb => 初始化 resque</p>

<figure class='code'><figcaption><span>config/redis.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">development</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">:redis</span><span class="p-Indicator">:</span> <span class="s">&quot;localhost:6379&quot;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>config/initializers/resque.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">config</span> <span class="o">=</span> <span class="no">YAML</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="si">}</span><span class="s2">/config/resque.yml&quot;</span><span class="p">)</span><span class="o">[</span><span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">]</span>
</span><span class='line'><span class="no">Resque</span><span class="o">.</span><span class="n">redis</span> <span class="o">=</span> <span class="n">config</span><span class="o">[</span><span class="ss">:redis</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<h6>RedisToGo</h6>

<p>若是使用雲端的Redis服務-<a href="https://redistogo.com/" target="_blank">RedisToGo</a><br/>
可以直接在 yml 中貼上 instance 的 uri, 如</p>

<figure class='code'><figcaption><span>config/redis.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">development</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">:redis</span><span class="p-Indicator">:</span> <span class="s">&quot;redis://marsz:xxxxxx@stingfish.redistogo.com:9999&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h6>redis-rb</h6>

<p>若 redis 有同時兼作 cache 或 db 用, 而且是透過 gem &#8220;redis&#8221; 進行連線的話<br/>
則可以直接將變數指定</p>

<figure class='code'><figcaption><span>config/redis.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">development</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">:db</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'>  <span class="l-Scalar-Plain">:host</span><span class="p-Indicator">:</span> <span class="s">&quot;localhost&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">:port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">6379</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>config/initializers/resque.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">config</span> <span class="o">=</span> <span class="no">YAML</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="si">}</span><span class="s2">/config/redis.yml&quot;</span><span class="p">))</span><span class="o">[</span><span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">]</span>
</span><span class='line'><span class="no">Resque</span><span class="o">.</span><span class="n">redis</span> <span class="o">=</span> <span class="no">Redis</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="ss">:host</span> <span class="o">=&gt;</span> <span class="n">config</span><span class="o">[</span><span class="ss">:host</span><span class="o">]</span><span class="p">,</span> <span class="ss">:port</span> <span class="o">=&gt;</span> <span class="n">config</span><span class="o">[</span><span class="ss">:port</span><span class="o">]</span><span class="p">,</span> <span class="ss">:db</span> <span class="o">=&gt;</span> <span class="n">config</span><span class="o">[</span><span class="ss">:db</span><span class="o">]</span> <span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>一般小弟比較偏好最後一個方法, 因為 redis 太方便了, 只做 background job 有點可惜 XD</p>

<h4>Resque server</h4>

<p>想要有直觀的介面可以看目前 message queue (redis) 上的 job 執行狀況<br/>
resque 也有提供 :)</p>

<figure class='code'><figcaption><span>config/initializers/resque.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># 在任何 initial 的檔案中加都可</span>
</span><span class='line'><span class="nb">require</span> <span class="s2">&quot;resque/server&quot;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>config/routes.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">mount</span> <span class="no">Resque</span><span class="o">::</span><span class="no">Server</span><span class="o">.</span><span class="n">new</span><span class="p">,</span> <span class="ss">:at</span> <span class="o">=&gt;</span> <span class="s2">&quot;/admin/resque&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>啟動 rails server, 連線 <a href="http://localhost:3000/admin/resque" target="_blank">http://localhost:3000/admin/resque</a> 就可以看到啦</p>

<h4>啟動 worker</h4>

<p>丟上 message queue 的工作, 必須透過 worker 逐個要下來執行<br/>
啟動worker&#8230;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">QUEUE</span><span class="o">=*</span> <span class="n">bundle</span> <span class="nb">exec</span> <span class="n">rake</span> <span class="n">resque</span><span class="ss">:work</span>
</span></code></pre></td></tr></table></div></figure>


<p>上述指令啟動後就會掛著, 而 server 上的啟動可以透過 BACKGROUND=yes 讓 worker 變成背景執行, 之後會再介紹完整參數說明</p>

<p>worker 在 message queue 中有許多 issue, 例如:<br/>
1. 佈署時如何自動的重啟<br/>
2. server 上的 worker 掛了要怎麼自動重啟<br/>
3. worker 能否 multi-thread 執行或針對特定 queue 等等<br/>
將在後續會有相關 solution 的分享</p>

<hr />

<p>以上是有關 resque 的環境設定</p>

<p>redis => resuqe config => worker</p>

<p>下一篇將會介紹在 rails 中的基本使用方式</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Devise + Omniauth 的 Facebook 登入範例]]></title>
    <link href="http://rubyist.marsz.tw/blog/2012-02-11/devise-omniauth-for-facebook-login/"/>
    <updated>2012-02-11T01:20:00+08:00</updated>
    <id>http://rubyist.marsz.tw/blog/2012-02-11/devise-omniauth-for-facebook-login</id>
    <content type="html"><![CDATA[<p>以下範例應用於 rails 3.1.3 + devise 1.4.9 + oa-oauth 0.3.2<br/>
直接使用 devise 中的 omniauthable 有許多彈性不足的問題<br/>
因此小弟參考了網路上的作法, 加上因應某些需求的修改&#8230;</p>

<!-- more -->


<h4>參考</h4>

<p><a href="http://blog.railsrumble.com/blog/2010/10/08/intridea-omniauth" target="_blank">http://blog.railsrumble.com/blog/2010/10/08/intridea-omniauth</a></p>

<h4>步驟</h4>

<p>(以下範例以 user 做為 model 名稱)</p>

<p>安裝 gem</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s2">&quot;devise&quot;</span><span class="p">,</span> <span class="s2">&quot;1.4.9&quot;</span>
</span><span class='line'><span class="n">gem</span> <span class="s2">&quot;oa-oauth&quot;</span><span class="p">,</span> <span class="ss">:require</span> <span class="o">=&gt;</span> <span class="s2">&quot;omniauth/oauth&quot;</span>
</span><span class='line'><span class="n">gem</span> <span class="s2">&quot;oa-openid&quot;</span><span class="p">,</span> <span class="ss">:require</span> <span class="o">=&gt;</span> <span class="s2">&quot;omniauth/openid&quot;</span> <span class="c1"># for google 或其他 openid auth</span>
</span></code></pre></td></tr></table></div></figure>


<p>devise initial setup</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">rails</span> <span class="n">g</span> <span class="n">devise</span><span class="ss">:install</span>
</span><span class='line'><span class="n">rails</span> <span class="n">g</span> <span class="n">devise</span> <span class="n">user</span>
</span></code></pre></td></tr></table></div></figure>


<p>在 users 的 migration 中, 依照需求可自行選擇加入</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">create_table</span><span class="p">(</span><span class="ss">:users</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class='line'>  <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:name</span> <span class="c1"># 儲存使用者名稱</span>
</span><span class='line'>  <span class="n">t</span><span class="o">.</span><span class="n">confirmable</span> <span class="c1"># email 認證, 若未來有提供註冊流程產生新使用者的可能性, 就加吧</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">change_column</span> <span class="ss">:users</span><span class="p">,</span><span class="ss">:email</span><span class="p">,</span> <span class="ss">:string</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="c1"># 若登入 open id 的 provider 不提供 email, 則必須做此設定, 讓 email 可以為 null</span>
</span></code></pre></td></tr></table></div></figure>


<p>建立對應 opend id 和 user 的 model - authorization</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">rails</span> <span class="n">g</span> <span class="n">model</span> <span class="n">authorization</span> <span class="n">provider</span><span class="ss">:string</span> <span class="n">uid</span><span class="ss">:string</span> <span class="n">user_id</span><span class="ss">:integer</span>
</span></code></pre></td></tr></table></div></figure>


<p>user model 內容<br/>
1. devise 的 module 比預設的多了 confirmable, 主要為了提供未來也能使用站內註冊流程的可能<br/>
2. create_from_auth 處理 omniauth 丟過來的 auth_hash 並且以 email 為 unique key 新增 user</p>

<figure class='code'><figcaption><span>app/models/user.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">devise</span> <span class="ss">:database_authenticatable</span><span class="p">,</span> <span class="ss">:registerable</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">:recoverable</span><span class="p">,</span> <span class="ss">:rememberable</span><span class="p">,</span> <span class="ss">:trackable</span><span class="p">,</span> <span class="ss">:validatable</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">:confirmable</span> <span class="c1"># 加上 confirmable</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:authorizations</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">create_from_auth!</span><span class="p">(</span><span class="nb">hash</span><span class="p">)</span>
</span><span class='line'>    <span class="n">created_hash</span> <span class="o">=</span> <span class="p">{</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="nb">hash</span><span class="o">[</span><span class="ss">:user_info</span><span class="o">][</span><span class="ss">:email</span><span class="o">]</span><span class="p">,</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="nb">hash</span><span class="o">[</span><span class="ss">:user_info</span><span class="o">][</span><span class="ss">:name</span><span class="o">]</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">user</span> <span class="o">=</span> <span class="p">(</span><span class="n">created_hash</span><span class="o">[</span><span class="ss">:email</span><span class="o">].</span><span class="n">nil?</span> <span class="p">?</span> <span class="kp">nil</span> <span class="p">:</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">created_hash</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span><span class="p">))</span> <span class="o">||</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">created_hash</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
</span><span class='line'>      <span class="n">user</span><span class="o">.</span><span class="n">confirm!</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">user</span>
</span><span class='line'>      <span class="n">user</span><span class="o">.</span><span class="n">save!</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">user</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>authorization model 內容<br/>
1. 對應 user 和 open id, 使其不重複<br/>
2. #create_by_omniauth 處理從 omniauth 登入後的資料, 可以將 provider 的資料整合進指定的user(例如目前登入者) 或相同 email 的 user<br/>
3. constant PROVIDERS 用以提供未來擴充 provider 的彈性</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Authorization</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="no">PROVIDERS</span> <span class="o">=</span> <span class="o">[</span><span class="ss">:facebook</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:user</span>
</span><span class='line'>  <span class="n">validates_presence_of</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">:uid</span><span class="p">,</span> <span class="ss">:provider</span>
</span><span class='line'>  <span class="n">validates_uniqueness_of</span> <span class="ss">:uid</span><span class="p">,</span> <span class="ss">:scope</span> <span class="o">=&gt;</span> <span class="ss">:provider</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">create_by_omniauth</span><span class="p">(</span><span class="nb">hash</span><span class="p">,</span> <span class="n">current_user</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">hash</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">HashWithIndifferentAccess</span><span class="o">.</span><span class="n">new</span> <span class="nb">hash</span>
</span><span class='line'>    <span class="n">auth</span> <span class="o">=</span> <span class="n">find_from_hash</span><span class="p">(</span><span class="nb">hash</span><span class="p">)</span>
</span><span class='line'>    <span class="k">unless</span> <span class="n">auth</span>
</span><span class='line'>      <span class="n">current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">create_from_auth!</span><span class="p">(</span><span class="nb">hash</span><span class="p">)</span>
</span><span class='line'>      <span class="n">auth</span> <span class="o">=</span> <span class="no">Authorization</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:user</span><span class="o">=&gt;</span><span class="n">current_user</span><span class="p">,</span><span class="ss">:uid</span><span class="o">=&gt;</span><span class="nb">hash</span><span class="o">[</span><span class="ss">:uid</span><span class="o">]</span><span class="p">,</span><span class="ss">:provider</span><span class="o">=&gt;</span><span class="nb">hash</span><span class="o">[</span><span class="ss">:provider</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>      <span class="n">auth</span><span class="o">.</span><span class="n">save</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">auth</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">find_from_hash</span><span class="p">(</span><span class="nb">hash</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="nb">hash</span><span class="o">[</span><span class="ss">:provider</span><span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">hash</span><span class="o">[</span><span class="ss">:uid</span><span class="o">]</span>
</span><span class='line'>      <span class="n">find_by_provider_and_uid</span><span class="p">(</span><span class="nb">hash</span><span class="o">[</span><span class="ss">:provider</span><span class="o">]</span><span class="p">,</span><span class="nb">hash</span><span class="o">[</span><span class="ss">:uid</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>設定 omniauth (facebook 登入的 app data), 同時讓 /auth/facebook 的 route 可以連接 fb 的 oauth, 相關可參考 <a href="https://github.com/intridea/omniauth" target="_blank">omniauth 的說明</a></p>

<figure class='code'><figcaption><span>config/initializers/omniauth.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">use</span> <span class="no">OmniAuth</span><span class="o">::</span><span class="no">Builder</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">config</span> <span class="o">=</span> <span class="no">YAML</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="si">}</span><span class="s2">/config/omniauth.yml&quot;</span><span class="p">))</span><span class="o">[</span><span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">]</span>
</span><span class='line'>  <span class="n">provider</span> <span class="ss">:facebook</span><span class="p">,</span> <span class="n">config</span><span class="o">[</span><span class="ss">:facebook</span><span class="o">][</span><span class="ss">:api_id</span><span class="o">]</span><span class="p">,</span> <span class="n">config</span><span class="o">[</span><span class="ss">:facebook</span><span class="o">][</span><span class="ss">:api_secret</span><span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>config/omniauth.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">development</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">:facebook</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">:domain</span><span class="p-Indicator">:</span> <span class="s">&quot;foo.com&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">:api_id</span><span class="p-Indicator">:</span> <span class="s">&quot;12341234&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">:api_secret</span><span class="p-Indicator">:</span> <span class="s">&quot;barbarbarbar&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">test</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">:facebook</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">:domain</span><span class="p-Indicator">:</span> <span class="s">&quot;foo.com&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">:api_id</span><span class="p-Indicator">:</span> <span class="s">&quot;12341234&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">:api_secret</span><span class="p-Indicator">:</span> <span class="s">&quot;barbarbarbar&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">production</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">:facebook</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">:domain</span><span class="p-Indicator">:</span> <span class="s">&quot;foo.com&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">:api_id</span><span class="p-Indicator">:</span> <span class="s">&quot;12341234&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">:api_secret</span><span class="p-Indicator">:</span> <span class="s">&quot;barbarbarbar&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>如同 omniauth 的做法, 把接 facebook (或其他 provider) 的 route 和 controller 寫好</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">rails</span> <span class="n">g</span> <span class="n">controller</span> <span class="n">sessions</span>
</span></code></pre></td></tr></table></div></figure>


<p>有可能登入 facebook 會 fail, 所以也要把 fail 的部份寫好</p>

<figure class='code'><figcaption><span>app/controllers/sessions_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>    <span class="vi">@auth</span> <span class="o">=</span> <span class="no">Authorization</span><span class="o">.</span><span class="n">create_by_omniauth</span><span class="p">(</span><span class="n">auth_hash</span><span class="p">,</span> <span class="n">current_user</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="vi">@auth</span><span class="o">.</span><span class="n">user</span>
</span><span class='line'>       <span class="n">sign_in_and_redirect</span> <span class="ss">:user</span><span class="p">,</span> <span class="vi">@auth</span><span class="o">.</span><span class="n">user</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="k">raise</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span> <span class="s2">&quot;auth_hash: </span><span class="si">#{</span><span class="n">auth_hash</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span> <span class="s2">&quot;@auth: </span><span class="si">#{</span><span class="vi">@auth</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>        <span class="n">redirect_to</span> <span class="n">new_user_session_path</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">failure</span>
</span><span class='line'>    <span class="n">flash</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:message</span><span class="o">]</span>
</span><span class='line'>    <span class="n">redirect_to</span> <span class="n">new_user_session_path</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">auth_hash</span>
</span><span class='line'>    <span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="o">[</span><span class="s1">&#39;omniauth.auth&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>設定 route, 包含 omniauth 和 devise</p>

<figure class='code'><figcaption><span>config/routes.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">match</span> <span class="s1">&#39;/auth/:provider/callback&#39;</span><span class="p">,</span> <span class="ss">:to</span> <span class="o">=&gt;</span> <span class="s1">&#39;sessions#create&#39;</span>
</span><span class='line'>  <span class="n">match</span> <span class="s1">&#39;/auth/failure&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;sessions#failure&#39;</span>
</span><span class='line'>  <span class="n">devise_for</span> <span class="ss">:users</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">get</span> <span class="s1">&#39;/users/sign_in&#39;</span><span class="p">,</span> <span class="ss">:to</span> <span class="o">=&gt;</span> <span class="s1">&#39;devise/sessions#new&#39;</span><span class="p">,</span> <span class="ss">:as</span> <span class="o">=&gt;</span> <span class="ss">:new_user_session</span>
</span><span class='line'>    <span class="n">get</span> <span class="s1">&#39;/users/sign_out&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;devise/sessions#destroy&#39;</span><span class="p">,</span> <span class="ss">:as</span> <span class="o">=&gt;</span> <span class="ss">:user_sign_out</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>view 裡面的 Facebook 登入按鈕 (html)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/auth/facebook&quot;</span><span class="nt">&gt;</span>Facebook 登入<span class="nt">&lt;/a&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>若希望 Facebook 登入後可以導回登入前的頁面, 則可以做以下設定<br/>
主要參考 <a href="https://github.com/plataformatec/devise/wiki/How-To:-Redirect-to-a-specific-page-on-successful-sign-in" target="_blank">Devise Wiki</a></p>

<figure class='code'><figcaption><span>app/controllers/application_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">after_sign_in_path_for</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'>    <span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="o">[</span><span class="s1">&#39;omniauth.origin&#39;</span><span class="o">]</span> <span class="o">||</span> <span class="n">stored_location_for</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="o">||</span> <span class="n">users_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>目前沒有使用 devise 1.5 以上的原因是在這裡會遇到 redirect loop 的問題</p>

<h4>結論</h4>

<p>本篇範例主要以最常用的 facebook 登入為主<br/>
另外也提供了整合 openid 至現有帳號的功能<br/>
大多數的使用者帳號系統最在意的是能否拿到 email, 雖然 Facebook 是最多人使用的 open id, 但是基於網站本身的內容特性, 提供網站自己的註冊流程也是必要的<br/>
接下來還有另一篇介紹上述範例中的 rspec 會怎麼寫</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[使用 Factory Girl 產生測試用資料]]></title>
    <link href="http://rubyist.marsz.tw/blog/2012-02-06/factory-girl-rails-intro/"/>
    <updated>2012-02-06T16:57:00+08:00</updated>
    <id>http://rubyist.marsz.tw/blog/2012-02-06/factory-girl-rails-intro</id>
    <content type="html"><![CDATA[<p>在寫測試的時候, 為了實際測試程式處理資料的正確性<br/>
免不了要依據資料庫的關聯建立假資料<br/>
但往往會因為 model 增加了一些 validation 而導致產生假資料的 code, 必須符合驗證而修改<br/>
當測試的量日漸龐大時, 改起來就會非常麻煩</p>

<!-- more -->


<p>factory_girl_rails 讓產生假資料的方式變得簡單和一致, 同時提昇 code 的可讀性<br/>
例如:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">before</span> <span class="k">do</span>
</span><span class='line'>  <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;foo@bar.com&quot;</span><span class="p">,</span> <span class="ss">:state</span> <span class="o">=&gt;</span> <span class="ss">:block</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>改用 factory_girl 後</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">before</span> <span class="k">do</span>
</span><span class='line'>  <span class="vi">@user</span> <span class="o">=</span> <span class="no">Factory</span> <span class="ss">:user_state_blocked</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h4>安裝</h4>

<figure class='code'><figcaption><span>Gemfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">group</span> <span class="ss">:test</span><span class="p">,</span> <span class="ss">:development</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s2">&quot;factory_girl_rails&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">bundle</span> <span class="n">install</span>
</span></code></pre></td></tr></table></div></figure>


<h4>設定</h4>

<p>factory 的設定建議一個檔案對應一個 model, 放在 spec/factories 下<br/>
例如 app/models/user.rb => sepc/factiries/user.rb<br/>
為了讓 rails g model 的時候, 可以自動產生對應的 factory file, 可以加入以下 code 在 config/application.rb</p>

<figure class='code'><figcaption><span>config/application.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">generators</span> <span class="k">do</span> <span class="o">|</span><span class="n">g</span><span class="o">|</span>
</span><span class='line'>  <span class="n">g</span><span class="o">.</span><span class="n">test_framework</span> <span class="ss">:rspec</span><span class="p">,</span> <span class="ss">:fixture</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:views</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span> <span class="ss">:fixture_replacement</span> <span class="o">=&gt;</span> <span class="ss">:factory_girl</span>
</span><span class='line'>  <span class="n">g</span><span class="o">.</span><span class="n">fixture_replacement</span> <span class="ss">:factory_girl</span><span class="p">,</span> <span class="ss">:dir</span> <span class="o">=&gt;</span> <span class="s2">&quot;spec/factories&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>之後只要 &#8220;rails g model user&#8221; 也會自動產生 spec/factories/user.rb<br/>
內容如下</p>

<figure class='code'><figcaption><span>spec/factories/user.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>針對已經存在的 model 可以透過 -s 來略過已存在的檔案</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">rails</span> <span class="n">g</span> <span class="n">model</span> <span class="n">user</span> <span class="o">-</span><span class="n">s</span>
</span></code></pre></td></tr></table></div></figure>


<h4>定義與使用</h4>

<p>基本, factory 內的 method 對應 column name</p>

<figure class='code'><figcaption><span>spec/factories/user.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">name</span> <span class="s2">&quot;foo&quot;</span>
</span><span class='line'>    <span class="n">email</span> <span class="s2">&quot;bar@foo.com&quot;</span>
</span><span class='line'>    <span class="n">password</span> <span class="s2">&quot;12341234&quot;</span>
</span><span class='line'>    <span class="n">birthday</span> <span class="s2">&quot;1982-03-30&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>巢狀定義, 可用於某種 test case 下的資料內容, 下層的 column 內容會覆寫上層</p>

<figure class='code'><figcaption><span>spec/factories/user.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">name</span> <span class="s2">&quot;foo&quot;</span>
</span><span class='line'>    <span class="n">email</span> <span class="s2">&quot;bar@foo.com&quot;</span>
</span><span class='line'>    <span class="n">password</span> <span class="s2">&quot;12341234&quot;</span>
</span><span class='line'>    <span class="n">birthday</span> <span class="s2">&quot;1982-03-30&quot;</span>
</span><span class='line'>    <span class="n">state</span> <span class="s2">&quot;actived&quot;</span>
</span><span class='line'>    <span class="n">factory</span> <span class="ss">:user_state_locked</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">state</span> <span class="s2">&quot;locked&quot;</span>
</span><span class='line'>      <span class="n">locked_at</span> <span class="s2">&quot;2012-12-12&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">factory</span> <span class="ss">:user_state_closed</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">state</span> <span class="s2">&quot;closed&quot;</span>
</span><span class='line'>      <span class="n">closed_at</span> <span class="s2">&quot;2012-12-12 12:12:12&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>spec/models/user_spec.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="vi">@user</span> <span class="o">=</span> <span class="no">Factory</span> <span class="ss">:user</span>
</span><span class='line'><span class="vi">@user_state_closed</span> <span class="o">=</span> <span class="no">Factory</span> <span class="ss">:user_state_closed</span>
</span><span class='line'><span class="vi">@user_state_locked</span> <span class="o">=</span> <span class="no">Factory</span> <span class="ss">:user_state_locked</span>
</span></code></pre></td></tr></table></div></figure>


<p>使用 factory 時, 也可以在後面的參數帶入自定欄位內容或關連</p>

<figure class='code'><figcaption><span>spec/models/user_spec.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="vi">@user</span> <span class="o">=</span> <span class="no">Factory</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">:birthday</span> <span class="o">=&gt;</span> <span class="s2">&quot;1983-01-28&quot;</span>
</span><span class='line'><span class="vi">@post</span> <span class="o">=</span> <span class="no">Factory</span> <span class="ss">:post</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@user</span>
</span></code></pre></td></tr></table></div></figure>


<p>下一篇將介紹更進階的 factory 定義!!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Facebook 辦公室的駭客精神標語]]></title>
    <link href="http://rubyist.marsz.tw/blog/2012-02-05/facebook-posters/"/>
    <updated>2012-02-05T01:04:00+08:00</updated>
    <id>http://rubyist.marsz.tw/blog/2012-02-05/facebook-posters</id>
    <content type="html"><![CDATA[<p>海報原文在<a href="http://designforfun.com/facebookposters/" target="_blank">這裡</a><br/>
每一句看了都令人非常的振奮<br/>
於是就來給它翻譯一下, 網路公司的辦公室都應該貼滿這些標語 XD</p>

<!-- more -->


<h4>Done is better than perfect</h4>

<p>比完美更重要的是完成</p>

<h4>Fortune favors the bold</h4>

<p>命運之神眷顧勇者</p>

<h4>Move faster and break things</h4>

<p>快速前進, 打破陳規</p>

<h4>Proceed and be bold</h4>

<p>大膽得向前推進 (翻得不是很好T_T)</p>

<h4>Stay focused &amp; Keep shipping</h4>

<p>保持專注, 持續推出產品</p>

<h4>What would you do if you weren&#8217;t afraid</h4>

<p>假如我不害怕，我會怎麼做？</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Rails Spec (4) model validations 的 spec]]></title>
    <link href="http://rubyist.marsz.tw/blog/2012-02-04/rails-rspec-model-spec/"/>
    <updated>2012-02-04T16:45:00+08:00</updated>
    <id>http://rubyist.marsz.tw/blog/2012-02-04/rails-rspec-model-spec</id>
    <content type="html"><![CDATA[<p>本篇將介紹以最原始, 沒有用任何外掛下的 model validation spec 寫法<br/>
若覺得小弟有更好的寫法, 也歡迎不吝指教 :)</p>

<!-- more -->


<p>範例中所使用的 matchers:</p>

<p>be_valid<br/>
be_true<br/>
be_false</p>

<p>model檔: User</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">validates_presence_of</span> <span class="ss">:name</span>
</span><span class='line'>  <span class="n">validates_length_of</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:in</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">20</span>
</span><span class='line'>  <span class="n">validates_uniqueness_of</span> <span class="ss">:email</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>spec 寫法 (spec/models/user_spec.rb)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">describe</span> <span class="s2">&quot;validations&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">before</span> <span class="k">do</span>
</span><span class='line'>      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;bar@foo.com&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;should be valid&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="vi">@user</span><span class="o">.</span><span class="n">should</span> <span class="n">be_valid</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;should not validate presence of :name&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>      <span class="vi">@user</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_valid</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;should not validate length of :name&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;foo&quot;</span> <span class="o">*</span> <span class="mi">20</span>
</span><span class='line'>      <span class="vi">@user</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_valid</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;should not validate uniqueness of :email&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
</span><span class='line'>      <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">attributes</span><span class="p">)</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_valid</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>be_valid 可以讓 @user 先把 save 以前的 validation 都跑過, 並且預期 return true<br/>
當然若要直接 save 以預期結果的話, 可以改寫成</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="vi">@user</span><span class="o">.</span><span class="n">save</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="kp">true</span>
</span><span class='line'><span class="vi">@user</span><span class="o">.</span><span class="n">save</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="kp">false</span>
</span></code></pre></td></tr></table></div></figure>


<p>或(可讀性較佳的寫法)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="vi">@user</span><span class="o">.</span><span class="n">save</span><span class="o">.</span><span class="n">should</span> <span class="n">be_true</span>
</span><span class='line'><span class="vi">@user</span><span class="o">.</span><span class="n">save</span><span class="o">.</span><span class="n">should</span> <span class="n">be_false</span>
</span></code></pre></td></tr></table></div></figure>


<p>謎之聲: 每個 validation 都要這樣寫好累 XD</p>

<p>當然上述的範例中除了麻煩之外, 當然 User 有追加了新的 validation 時, before 的 User.new 也要跟著對應, 倘若有很多需要 create user model 的 spec 時, 改起來就會很痛苦</p>

<p>因此上述的兩個 issue, 將會在下兩篇將會介紹透過 factory_girl_rails 和 shoulda-matchers 這兩個 gem 解決</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Rails Rspec (3) pending 的使用]]></title>
    <link href="http://rubyist.marsz.tw/blog/2012-02-03/rails-rspec-pending/"/>
    <updated>2012-02-03T16:06:00+08:00</updated>
    <id>http://rubyist.marsz.tw/blog/2012-02-03/rails-rspec-pending</id>
    <content type="html"><![CDATA[<p>pending 的使用可先參考 <a href="https://github.com/dchelimsky/rspec/wiki/Pending-Examples" target="_blank">官方文件</a><br/>
一般 generator 產生的 spec 檔都會先幫你把 pending 加好</p>

<!-- more -->




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">describe</span> <span class="no">Foo</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">pending</span> <span class="s2">&quot;add some examples to (or delete) </span><span class="si">#{</span><span class="bp">__FILE__</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>如此便可在你跑 spec 後, 顯示有幾個 pending 尚未實作</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="mi">1</span> <span class="n">example</span><span class="p">,</span> <span class="mi">0</span> <span class="n">failures</span><span class="p">,</span> <span class="mi">1</span> <span class="n">pending</span>
</span></code></pre></td></tr></table></div></figure>


<p>因為不是每個專案都會讓你有時間寫 spec<br/>
等到有時間寫的時候, 可能會因為累積了太多而不知該從何寫起<br/>
所以 pending 的功用可讓你在未來能透過 pending 的麵包屑回頭逐一把 spec 補上</p>

<p>因此無論再怎麼趕怎麼忙, 也必須先將 pending 寫上</p>

<p>pending 可分幾個層次如下&#8230;</p>

<h4>整個 class 的 pending</h4>

<p>用於 lib class 較多, 當然遇到超趕的時候 controller, model 也都會整個 pending ~ XD</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">describe</span> <span class="no">FoosController</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">pending</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h4>某個 method 的 pending</h4>

<p>新加的 method, 或 method 改寫了, 原先的 spec 不敷使用</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">describe</span> <span class="no">Foo</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">describe</span> <span class="s2">&quot;#bar&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">pending</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>或</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">describe</span> <span class="no">Foo</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">pending</span> <span class="s2">&quot;#bar&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>一般都是後者的寫法</p>

<h4>method/action 內的某個 case</h4>

<p>針對單一 method/action 寫測試, test case 數通常取決於有多少 if else 在裡頭, 當然遇到比較特殊的 method/action 時, 可能也會有幾個 test case 是為預期錯誤而做的</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">describe</span> <span class="no">Foo</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">describe</span> <span class="s2">&quot;#bar&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;should be a kind of Bar&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">pending</span> <span class="s2">&quot;should raise error if bar_id is nil&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>另外, method 只針對 public methods 寫, 一般 protected 和 private method 都不寫 spec<br/>
嚴謹的專案, 對於 model 的 association, validation, callbacks, scope 也都會寫對應的 spec<br/>
我的習慣是, 在每次 commit 前檢查本此修改是否需要補 spec 或 pending, 補完後才一起 commit</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Rails Rspec (2) 基本語法與執行]]></title>
    <link href="http://rubyist.marsz.tw/blog/2012-02-02/rails-rspec-basic-syntax/"/>
    <updated>2012-02-02T14:35:00+08:00</updated>
    <id>http://rubyist.marsz.tw/blog/2012-02-02/rails-rspec-basic-syntax</id>
    <content type="html"><![CDATA[<p>建議在開始本系列文以前先讀過, 以下參考文件與資源</p>

<!-- more -->


<p><a href="http://www.slideshare.net/ihower/rspec-7394497" target="_blank">ihower 投影片</a> - 必看!!!!!<br/>
<a href="http://rubydoc.info/gems/rspec-core/2.8.0/file/README.md#" target="_blank">Rspec-core Rdoc</a> - 架構必看!!!<br/>
<a href="https://github.com/rspec/rspec-rails" target="_blank">Rspec Rails</a> - 官方提供的簡單範例 for models, controllers, routes, helpers 等</p>

<h4>describe 與 it + should</h4>

<p>最簡單的 rspec 可由 describe 和 it 組成<br/>
it 裡面必須有 should (或其他 match 語法) 才會構成測試</p>

<p>小弟在初學 rspec 的時候, 大多透過 should == 和 should_not == 就吃遍天下了 :p<br/>
一般在初學 rspec 時, 需要多注意 describe 和 it 的階層關係, 才會讓你的 spec 可讀性較高</p>

<p>有規劃的 spec</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">describe</span> <span class="no">Foo</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">describe</span> <span class="s2">&quot;#get_bar&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;should be nil&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="no">Foo</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">get_bar</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="kp">nil</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;should be Bar&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="no">Foo</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">get_bar</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="no">Bar</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>沒有規劃的 spec</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">describe</span> <span class="no">Foo</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">it</span> <span class="s2">&quot;#get_bar&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="no">Foo</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">get_bar</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="kp">nil</span> <span class="c1"># 當這行的測試沒過時, 下面的測試便不會再執行</span>
</span><span class='line'>    <span class="no">Foo</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">get_bar</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="no">Bar</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>盡可能讓每個 it 都是針對一種結果進行測試<br/>
描述中用 # 開頭的就表示是 method name</p>

<p>當漸漸學會其他的 match 語法時, 可讀性就去更高了
例如 <a href="http://apidock.com/rspec/Spec/Matchers/be_a_kind_of" target="_blank">be_a_kind_of</a> 可用於做 is_a_kind_of 的 match</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Foo</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">get_bar</span><span class="o">.</span><span class="n">should</span> <span class="n">be_a_kind_of</span><span class="p">(</span><span class="no">Bar</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>相當於</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Foo</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">get_bar</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="no">Bar</span>
</span></code></pre></td></tr></table></div></figure>


<p>前者的可讀性是比較高的</p>

<h4>before 與 it</h4>

<p>before 必定是在某個 describe 下, 而 before 內的行為會在每個 it 以前執行<br/>
而善用 instance 變數, 可以將 before 產生的變數傳遞給底下每個 it 用</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">describe</span> <span class="no">Foo</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">before</span> <span class="k">do</span>
</span><span class='line'>    <span class="vi">@foo</span> <span class="o">=</span> <span class="no">Foo</span><span class="o">.</span><span class="n">create!</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">describe</span> <span class="s2">&quot;#bar&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">before</span> <span class="k">do</span>
</span><span class='line'>      <span class="vi">@bar</span> <span class="o">=</span> <span class="no">Bar</span><span class="o">.</span><span class="n">create!</span>
</span><span class='line'>      <span class="vi">@foo</span><span class="o">.</span><span class="n">bar</span> <span class="o">=</span> <span class="vi">@bar</span>
</span><span class='line'>      <span class="vi">@foo</span><span class="o">.</span><span class="n">save</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;should be Bar&quot;</span> <span class="k">do</span>
</span><span class='line'>       <span class="vi">@foo</span><span class="o">.</span><span class="n">bar</span><span class="o">.</span><span class="n">should</span> <span class="n">be_a_kind_of</span><span class="p">(</span><span class="no">Bar</span><span class="p">)</span> <span class="c1"># 可以拿到 @foo</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;should be equeal to @bar&quot;</span> <span class="k">do</span>
</span><span class='line'>       <span class="vi">@foo</span><span class="o">.</span><span class="n">bar</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="vi">@bar</span><span class="o">.</span><span class="n">id</span> <span class="c1"># 也可以拿到 @bar</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">it</span> <span class="s2">&quot;be a kind of Foo&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="vi">@foo</span><span class="o">.</span><span class="n">should</span> <span class="n">be_a_kind_of</span><span class="p">(</span><span class="no">Foo</span><span class="p">)</span> <span class="c1"># 只能拿到 @foo</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>此外每個 it 結束後, 都會將此 it (含 before) 內對 test db 的修改通通 rollback, 因此我們可視為每個 it 執行前 (before 前), test db 都會是空的</p>

<h4>執行測試</h4>

<p>必須注意:</p>

<ol>
<li>config/database.yml 必須要有 test env 的設定, 且 database 不能和 migrate 一樣</li>
<li>執行前若 development 有 migrations 沒跑的話, 必須先跑完</li>
</ol>


<p>跑 spec/ 下的所有測試</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">bundle</span> <span class="nb">exec</span> <span class="n">rake</span> <span class="n">spec</span>
</span></code></pre></td></tr></table></div></figure>


<p>跑單一檔案的 spec</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">bundle</span> <span class="nb">exec</span> <span class="n">rspec</span> <span class="n">spec</span><span class="o">/</span><span class="n">models</span><span class="o">/</span><span class="n">foo_spec</span><span class="o">.</span><span class="n">rb</span>
</span></code></pre></td></tr></table></div></figure>


<p>跑單一檔案時, 不會先重新 load db schema, 因此若有新的 migrations 在 development 跑過後, 必須先 rake spec 後才能跑單一檔案的 rspec</p>

<p>更多 rspec 指令的應用</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">bundle</span> <span class="nb">exec</span> <span class="n">rspec</span> <span class="o">-</span><span class="n">h</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
</feed>
